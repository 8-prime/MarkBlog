@page "/article-overview/{page?}"
@using Markblog.Infrastructure.Contexts
@using Markblog.Infrastructure.Entities
@using Microsoft.EntityFrameworkCore
@layout EmptyLayout
@inject ArticleContext context
@inject IConfiguration config


@for (int i = 0; i < articles?.Length; i++)
{
    <a href="/article/@articles[i].Id" @attributes="@GetAttribute(i)" class="cursor-pointer p-4 bg-[#f3f4f6] rounded-lg shadow-2xl flex flex-col gap-2 hover:text-[#015635] text-black">
        <div class="flex flex-row justify-between">
            <h2 class="font-bold text-2xl"> @articles[i].Title </h2>
            <span style="line-height: 32px">@articles[i].CreatedDate.ToShortDateString()</span>
        </div>
        <p> @articles[i].Description </p>
        <div class="flex flex-row justify-between w-full">
            <div class="flex flex-row">
                <img src="icons/tags.svg" />
                <span style="line-height: 32px">@articles[i].Tags?.Replace("\n", ", ")</span>
            </div>
            <div class="flex flex-row">
                <img src="icons/timer.svg" />
                <span style="line-height: 32px" class="text-nowrap">@ReadDuration(articles[i].ReadDurationSeconds)</span>
            </div>
        </div>
    </a>
}


@code
{
    [SupplyParameterFromQuery]
    [Parameter]
    public int? Page { get; set; }

    private int PageSize { get; set; }

    private ArticleEntity[]? articles;

    protected override async Task OnInitializedAsync()
    {
        if (!int.TryParse(config.GetRequiredSection("PageSize").Value, out int pageSize))
        {
            pageSize = 10;
        }
        PageSize = pageSize;
        var skipPage = Math.Max(0, (Page ?? 0) - 1);
        articles = await context.Articles
                            .AsNoTracking()
                            .Skip(pageSize * skipPage)
                            .Take(pageSize)
                            .ToArrayAsync();
    }

    private Dictionary<string, object> GetAttribute(int index)
    {
        var attrs = new Dictionary<string, object>();
        if (index - 2 != articles?.Length && index - 2 > 0)
        {
            return attrs;
        }

        attrs.Add("hx-get", $"/article-overview/?page={Page + 1}");
        attrs.Add("hx-trigger", "revealed");
        attrs.Add("hx-swap", "afterend");

        return attrs;
    }

    private string ReadDuration(int seconds)
    {
        if (seconds > 60)
        {
            return $"{seconds / 60} min read";
        }
        return $"{seconds} sec read";
    }
}