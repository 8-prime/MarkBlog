@page "/article-overview/{page?}"
@using Markblog.Infrastructure.Contexts
@using Markblog.Infrastructure.Entities
@using Microsoft.EntityFrameworkCore
@layout EmptyLayout
@inject ArticleContext context
@inject IConfiguration config


@if (articles?.Length == 0)
{
    <div>
        <h2>You have reached the end. Thanks for scrolling :D </h2>
    </div>
}
else
{
    @for (int i = 0; i < articles?.Length; i++)
    {
        @if (i == PageSize - 2)
        {
            <div hx-get="/article-overview/?page=@(Page + 1)"
                 hx-trigger="revealed"
                 hx-swap="afterend"
                 class="p-12 bg-[#575e62] rounded-lg shadow-2xl">
                <h2> @articles[i].Title </h2>
                <p> @articles[i].Description </p>
                <p> @articles[i].CreatedDate </p>
                <p> Read duration: @articles[i].ReadDurationSeconds </p>
            </div>
        }
        else
        {
            <div class="p-12 bg-[#575e62] rounded-lg shadow-2xl">
                <h2> @articles[i].Title </h2>
                <p> @articles[i].Description </p>
                <p> @articles[i].CreatedDate </p>
                <p> Read duration: @articles[i].ReadDurationSeconds </p>
            </div>
        }
    }
}


@code
{
    [SupplyParameterFromQuery]
    [Parameter]
    public int? Page { get; set; }

    private int PageSize { get; set; }

    private ArticleEntity[]? articles;

    protected override async Task OnInitializedAsync()
    {
        if (!int.TryParse(config.GetRequiredSection("PageSize").Value, out int pageSize))
        {
            pageSize = 10;
        }
        PageSize = pageSize;
        var skipPage = Math.Max(0, (Page ?? 0) - 1);
        articles = await context.Articles
                            .AsNoTracking()
                            .Skip(pageSize * skipPage)
                            .Take(pageSize)
                            .ToArrayAsync();
    }
}